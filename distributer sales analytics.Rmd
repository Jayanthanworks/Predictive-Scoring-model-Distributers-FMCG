---
title: "Distributer Sales Analytics"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
# Business Background : 
#The Company 'X' has got 93 Distributers in the TN region for selling it's products to the retail and institutional customers in the market.
# The category handles is stationary products
# The Sales data is present for all these dis's from 2014 to 2017 March both in qty and value overall/category wise/month wise.

# Business Objective : 
#1)To find the Active & inactive distributers based on their secondary Sales.

#2)To design and channelise trade schemes based on distributer's #futureperformance( secondary sales) 

#3)To identify poor performers and take corrective actions for sales improvement 
                        

# Concepts Exploration: 
#1)RFM Analysis - ( Recency,Frequency,Monetory)
#2)Scoring model deployment consisting of probability                       
# model and prediction model to predict sales.
#3)Flowchart on Model : 
#  1)find RFM metrics for the distributers who billed on 2015.                         
#  2)To create seperate dataframe for customers who actually billed on 2016.
#  3)To create a probability model for the active distributers(billed on 2016) #with RFM metrics captured on year 2015
#  4)To Create a predictive model(Regression)fordistributers billed in 2016 #against Avg and Max value parameters in the year 2015.
#  5)To creat a new RFM model till current data and fit the created probaibilty and prediction modelin the distributer's data 

# To be precise -The model will find out what is the proability of a distributer being Active on inActive / If Active how much Sales will be generated ?             
```

```{r}
getwd()
setwd("C:/Users/Jayanthan/Downloads")
dist_data<- read.csv("Distributer sales analytics 1.csv",header = FALSE) 
class(dist_data) # Dataframe
head(dist_data) 

```

```{r}
# Naming the columns of the dataframe
colnames(dist_data)<-c("Distributer","date","sales")
View(dist_data)
```

```{r}
# To extract date of purchase and year of purchase seperately
dist_data$date<-as.Date(dist_data$date,"%Y-%m-%d")
dist_data$year_purchase<-as.numeric(format(dist_data$date,"%Y"))
summary(dist_data)
```

```{r}
# Defining time period defined till 22 march 2017 
dist_data$days_since<-as.numeric(difftime(time1 = "2017-04-22",
                                          time2 = dist_data$date,
                                          units = "days"))
```

```{r}
library(sqldf)

# Compute RFM variables as of a year ago
Distributers_2015 = sqldf("SELECT Distributer,
                               MIN(days_since) - 365 AS 'recency',
                               MAX(days_since) - 365 AS 'first_purchase',
                               COUNT(*) AS 'frequency',
                               AVG(sales) AS 'avg_amount',
                               MAX(sales) AS 'max_amount'
                        FROM dist_data
                        WHERE days_since > 365
                        GROUP BY 1")
head(Distributers_2015)

```

```{r}
# Compute revenues generated by customers in 2016

revenue_2016 = sqldf("SELECT Distributer, SUM(sales) AS 'revenue_2016'
                      FROM dist_data
                      WHERE year_purchase = 2016
                      GROUP BY 1")
head(revenue_2016)
```

```{r}
# Create a dataframe by Merging 2015 'Distributers' and 2016 'revenue'

combine_data<-merge(Distributers_2015,revenue_2016,all.x = TRUE)

combine_data$revenue_2016[is.na(combine_data$revenue_2016)]=0

combine_data$active_2016 = as.numeric(combine_data$revenue_2016 > 0)

```

```{r}
head(combine_data)
View(combine_data)
summary(combine_data)
```

```{r}
# Building a probability model with multinom function
library(nnet)
prob.model = multinom(formula = active_2016~recency +  first_purchase + 
                        frequency + avg_amount + max_amount,
                      data = combine_data)
```

```{r}
coef = summary(prob.model)$coefficients
std = summary(prob.model)$standard.errors
print(coef)
print(std)
print(coef / std)

```

```{r}
# Creating a separate dataframe for those active purchases in 2016
z = which(combine_data$active_2016 == 1)
head(combine_data[z, ])
summary(combine_data[z,])
```

```{r}
# Building a prediction Sales model -1 

amount.model = lm(formula = revenue_2016 ~ avg_amount+max_amount,data =    
                   combine_data[z,])
summary(amount.model)

```

```{r}
# visualise the prediction 
plot(x = combine_data[z,]$revenue_2016, y = amount.model$fitted.values)

# Observation : As the date seems not to bring out a linear model. We will convert the prediction to log
```

```{r}
#  New Prediction model, using a log-transform (version 2)
amount.model = lm(formula = log(revenue_2016) ~ log(avg_amount) + 
                                  log(max_amount), data = combine_data[z, ])
summary(amount.model)

# observation - Pvalue seems significant for Avgamount
```

```{r}
# Plotting the Actual and predicted model


plot(x = log(combine_data[z,]$ revenue_2016),y= amount.model$fitted.values)

```

```{r}
# Compute RFM variables till current date
Distributers_2016 = sqldf("SELECT Distributer,
                               MIN(days_since) AS 'recency',
                               MAX(days_since) AS 'first_purchase',
                               COUNT(*) AS 'frequency',
                               AVG(sales) AS 'avg_amount',
                               MAX(sales) AS 'max_amount'
                        FROM dist_data GROUP BY 1")

head(Distributers_2016)
```

```{r}
View(Distributers_2016)
```

```{r}
# Prediction of probability,Sales, Scoring  based on 2016 data 
Distributers_2016$prob_predict<-predict(object = prob.model,newdata = Distributers_2016,type = "probs")
Distributers_2016$revenue_predict<-exp(predict(object=amount.model,newdata = Distributers_2016))
Distributers_2016$score_predict<-Distributers_2016$prob_predict*Distributers_2016$revenue_predict

```

```{r}
head(Distributers_2016$revenue_predict)
View(Distributers_2016$revenue_predict)
hist(Distributers_2016$score_predict)
# The Histogram of Distributers score against frequency gives that majority of them lies under a score of 10.
```

```{r}
# How many distributers will have an expected revenue of more than 50 L?
M = which(Distributers_2016$score_predict > 80)
print(length(M))
M
```

```{r}
#How many distributers will have an expected revenue of more than 10 L?
N = which(Distributers_2016$score_predict > 10)
print(length(N))
N
# 10 Distributers will have sales projection more than 10 lacs
```

```{r}
# Conclusion : As per the Inferences in the RESULT BELOW
summary(Distributers_2016$prob_predict)
# The avg probabilty of being an active Distributer is only 15.61 % and there are some distributers who will be 100 % probable for billing. 

summary(Distributers_2016$revenue_predict)
# The Avg Predicted sales projection among the Active distributers(billed on 2016) will be 4.97 lacs and a maximum up to 80 lacs.

summary(Distributers_2016$score_predict)

# The Average score is 3.37 ie out of the total 93 Distributers - 3.37 will be the average sales projection.

# How many distributers will have an expected revenue of more than 50 L?
M = which(Distributers_2016$score_predict > 80)
print(length(M))
M
# The distributer Maria Enterprises is predicted to have a sale of more than 80 lacs

#How many distributers will have an expected revenue of more than 10 L?
N = which(Distributers_2016$score_predict > 10)
print(length(N))
N
# 10 Distributers will have sales projection more than 10 lacs

```

```{r}
# The Probabilty~prediction model score for the overall 93 distributers gives us an idea for designing and optimising trade schemes.
# out of 93 - 21 distributers have a positive score of actually being active next year ie 2017 .
# These 27 distributers can be considered for optimising the Trade schemes
# The RFm Factor gives an idea of Active and Non active Distributers.
#  22 Distributers are found to be not performing in terms of Frequecny and Avg value.
```

```{r}

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
